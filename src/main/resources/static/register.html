<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>注册页</title>
    <link rel="stylesheet" href="assets/libs/layui/css/layui.css"/>
    <!--注册页的css-->
    <link rel="stylesheet" href="assets/css/register.css">
    <link rel="icon" href="../frame/static/image/code.png">
</head>
<body>
<div class="regis-content">
	<div class="login-main">
	    <header class="layui-elip" style="width: 82%">注册页</header>
	
	    <!-- 表单选项 -->
	    <form class="layui-form">
	
	        <div class="layui-form-item">
	            <label class="layui-form-label">昵称</label>
	            <div class="layui-input-block">
	                <input type="text" id="nickName" name="nickName" required  lay-verify="required" placeholder="请输入昵称"
	                       autocomplete="off" class="layui-input">
	                       <i class="encryption">*</i>
	            </div>
	        </div>
	
	        <div class="layui-form-item">
	            <label class="layui-form-label">性别</label>
	            <div class="layui-input-inline">
	                <input type="radio" name="sex" value="男" title="男" checked/>
	                <input type="radio" name="sex" value="女" title="女"/>
	            </div>
	        </div>
	
	        <div class="layui-form-item">
	            <label class="layui-form-label">用户名</label>
	            <div class="layui-input-block">
	                <input type="text" id="username" name="username" required  lay-verify="required" placeholder="请输入用户名"
	                       autocomplete="off" class="layui-input">
	                       <i class="encryption">*</i>
	                <!-- 对号 -->
	                <div class="layui-inline">
	                    <i class="layui-icon" id="ri" style="color: green;font-weight: bolder;" hidden></i>
	                </div>
	                <!-- 错号 -->
	                <div class="layui-inline">
	                    <i class="layui-icon" id="wr" style="color: red; font-weight: bolder;" hidden>ဆ</i>
	                </div>
	            </div>
	        </div>
	
	        <div class="layui-form-item" pane="">
	            <label class="layui-form-label">角色</label>
	            <div class="layui-input-inline">
	                <input name="role" value="1" title="管理员" type="checkbox"  lay-skin="primary">
	                <input name="role" value="2" title="普通用户" type="checkbox" lay-skin="primary">
	            </div>
	        </div>
	
	        <div class="layui-form-item">
	            <label class="layui-form-label">密码</label>
	            <div class="layui-input-block">
	                <input type="password" id="pwd" name="password" required  lay-verify="required" placeholder="请输入密码"
	                       autocomplete="off" class="layui-input">
	                       <i class="encryption">*</i>
	                <!-- 对号 -->
	                <div class="layui-inline">
	                    <i class="layui-icon" id="pri" style="color: green;font-weight: bolder;" hidden></i>
	                </div>
	                <!-- 错号 -->
	                <div class="layui-inline">
	                    <i class="layui-icon" id="pwr" style="color: red; font-weight: bolder;" hidden>ဆ</i>
	                </div>
	            </div>
	
	        </div>
	
	        <div class="layui-form-item">
	            <label class="layui-form-label">确认密码</label>
	            <div class="layui-input-block">
	                <input type="password" id="rpwd" name="repassword" required  lay-verify="required" placeholder="请确认密码"
	                       autocomplete="off" class="layui-input">
	                       <i class="encryption">*</i>
	                <!-- 对号 -->
	                <div class="layui-inline">
	                    <i class="layui-icon" id="rpri" style="color: green;font-weight: bolder;" hidden></i>
	                </div>
	                <!-- 错号 -->
	                <div class="layui-inline">
	                    <i class="layui-icon" id="rpwr" style="color: red; font-weight: bolder;" hidden>ဆ</i>
	                </div>
	            </div>
	        </div>
	
	        <div class="layui-form-item">
	            <label class="layui-form-label">手机号码</label>
	            <div class="layui-input-block">
	                <input type="text" id="phone" name="phone" required  lay-verify="required" placeholder="请输入手机号码"
	                       autocomplete="off" class="layui-input">
	                       <i class="encryption">*</i>
	                <!-- 对号 -->
	                <div class="layui-inline">
	                    <i class="layui-icon" id="phri" style="color: green;font-weight: bolder;" hidden></i>
	                </div>
	                <!-- 错号 -->
	                <div class="layui-inline">
	                    <i class="layui-icon" id="phwr" style="color: red; font-weight: bolder;" hidden>ဆ</i>
	                </div>
	            </div>
	        </div>
	
	        <div class="layui-input-inline login-btn" style="width: 93%">
	            <button type="submit" lay-submit lay-filter="sub" class="layui-btn">注册</button>
	        </div>
	        <hr style="width: 93%" />
	        <p style="width: 93%;overflow: hidden;">
	            <a href="login.html" class="fl">已有账号？立即登录</a>
				<!--<a href="javascript:;" class="fr">忘记密码？</a>-->
	        </p>
	        <p class="reg-tips">
	        	注：<span style="color:red">*</span>　号为必填项。
	        </p>
	    </form>
	    <div class="login-footer">
	        <p>
	            <span><a href="http://www.gguow.com/" target="_blank">神州远景(西安)科技发展有限公司</a></span>
	        </p>
	    </div>
	</div>
</div>


<script src="assets/libs/layui/layui.js"></script>
<script type="text/javascript">

        layui.use(['form','jquery','layer'], function () {
            var form   = layui.form;
            var $      = layui.jquery;
            var layer  = layui.layer;

        //添加表单失焦事件
        //验证表单
        $('#username').blur(function() {
            var username = $(this).val();
            $.ajax({
                url:'register/checkUsername',
                type:'get',
                dataType:'text',
                data:{username:username},
                //验证用户名是否可用
                success:function(data){
                    var obj = JSON.parse(data);
                    if (obj.code == 200) {
                       $('#ri').removeAttr('hidden');
                       $('#wr').attr('hidden','hidden');
                    }else {
                        $('#wr').removeAttr('hidden');
                        $('#ri').attr('hidden','hidden');
                        layer.msg('当前用户名已被占用!')
                    }
                }
            })
        });

        // 为密码添加正则验证
        $('#pwd').blur(function() {
            var reg = /^[\w]{6,12}$/;
            if(!($('#pwd').val().match(reg))){
                $('#pwr').removeAttr('hidden');
                $('#pri').attr('hidden','hidden');
                layer.msg('请输入合法密码');
            }else {
                $('#pri').removeAttr('hidden');
                $('#pwr').attr('hidden','hidden');
            }
        });

        //  验证两次密码是否一致
        $('#rpwd').blur(function() {
            if($('#pwd').val() != $('#rpwd').val()){
                $('#rpwr').removeAttr('hidden');
                $('#rpri').attr('hidden','hidden');
                layer.msg('两次输入密码不一致!');
            }else {
                $('#rpri').removeAttr('hidden');
                $('#rpwr').attr('hidden','hidden');
            };
        });

        //  为手机号码添加正则验证
        $('#phone').blur(function() {
            var reg = /^1([38][0-9]|4[579]|5[0-3,5-9]|6[6]|7[0135678]|9[89])\d{8}$/;
            if(!($('#phone').val().match(reg))){
                $('#phwr').removeAttr('hidden');
                $('#phri').attr('hidden','hidden');
                layer.msg('请输入合法手机号码');
            }else {
                var phone = $(this).val();
                $.ajax({
                    url:'register/checkPhone',
                    type:'get',
                    dataType:'text',
                    data:{phone:phone},
                    //  手机号码唯一性
                    success:function(data){
                        var obj = JSON.parse(data);
                        if (obj.code == 200) {
                            //  该手机号码可用
                            $('#phri').removeAttr('hidden');
                            $('#phwr').attr('hidden','hidden');
                        }else {
                            //  该手机号码已存在
                            $('#phwr').removeAttr('hidden');
                            $('#phri').attr('hidden','hidden');
                            layer.msg('该手机号码已存在');
                        }
                    }
                })
            }
        });

        //添加表单监听事件,提交注册信息
        form.on('submit(sub)', function() {

            var checkboxValue="";
            $("input:checkbox[name='role']:checked").each(function() {
                if(checkboxValue==0){
                    checkboxValue = $(this).val();
                    return true;
                }
                checkboxValue += ',' + $(this).val();//将被选择的值追加到
            });

            if(!checkboxValue){
                layer.msg('请选择注册用户的角色');
                return false;//阻止表单提交
            }else {
            }

			if($('#pwd').val() != $('#rpwd').val()){
				layer.msg('两次输入密码不一致!');
				return false;//阻止表单提交
			}

			var reg = /^1([38][0-9]|4[579]|5[0-3,5-9]|6[6]|7[0135678]|9[89])\d{8}$/;
			if(!($('#phone').val().match(reg))){
				layer.msg('请输入合法手机号码');
				return false;//阻止表单提交
			}else {
				var phone = $('#phone').val();
				$.ajax({
					url:'register/checkPhone',
					type:'get',
					dataType:'text',
					data:{phone:phone},
					//  手机号码唯一性
					success:function(data){
						var obj = JSON.parse(data);
						if (obj.code == 200) {
							//  该手机号码可用
							$.ajax({
								url:'register',
								type:'post',
								dataType:'text',
								data:{
									nickName:$('#nickName').val(),
									username:$('#username').val(),
									password:$('#pwd').val(),
									phone:$('#phone').val(),
									sex:$(':radio[name="sex"]:checked').val(),
									roleIds:checkboxValue
								},
								success:function(data){
									var obj = JSON.parse(data);
									if (obj.code == 200) {
										layer.msg('注册成功');
									}else {
										layer.msg('注册失败');
									}
								}
							})

						}else {
							//  该手机号码已存在
							layer.msg('该手机号码已存在');
							return false;//阻止表单提交
						}
					}
				})
			}
            //  防止页面跳转
            return false;
        });
    });
</script>
</body>
</html>